<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMO Admin - Bearbeiten</title>
    <link rel="stylesheet" href="../css/league-modern.css">
    <style>
        :root {
            --color-primary: #E2001A;
            --color-primary-hover: #ff1a35;
            --color-live: #00FF88;
            --color-bg-dark: #0D0D0D;
            --color-bg-card: #1A1F1A;
            --color-bg-elevated: #1E231E;
            --color-border: rgba(255, 255, 255, 0.08);
            --color-text-primary: #FFFFFF;
            --color-text-secondary: #A0A0A0;
            --radius-md: 12px;
            --radius-lg: 16px;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--color-bg-dark);
            color: var(--color-text-primary);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            min-height: 100vh;
        }

        a {
            color: var(--color-primary);
            text-decoration: none;
        }

        .editor-container {
            max-width: 950px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .card {
            background: var(--color-bg-card);
            padding: 30px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
        }

        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .header-actions h2 {
            margin: 0;
            font-weight: 700;
        }

        .match-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: var(--color-bg-elevated);
            border-radius: var(--radius-md);
            margin-bottom: 10px;
        }

        .teams-display {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }

        .inputs-display {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        input, select, textarea {
            background: var(--color-bg-dark);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: var(--color-text-primary);
            padding: 10px 14px;
            font-family: inherit;
            font-size: 0.95rem;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        input.score-input {
            width: 60px;
            padding: 10px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .save-bar {
            position: sticky;
            bottom: 20px;
            background: var(--color-bg-card);
            padding: 16px 20px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 12px;
            margin-top: 24px;
        }

        button {
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 0.95rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        button.btn-primary {
            background: var(--color-primary);
            color: white;
        }

        button.btn-primary:hover {
            background: var(--color-primary-hover);
            transform: translateY(-1px);
        }

        button.btn-secondary {
            background: var(--color-bg-elevated);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border);
        }

        .status-msg {
            margin-right: auto;
            font-weight: 500;
            color: var(--color-live);
        }

        label {
            color: var(--color-text-secondary);
            font-weight: 500;
        }

        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23A0A0A0' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--color-bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--color-bg-elevated); border-radius: 4px; }
    </style>
</head>

<body>

    <div class="editor-container">
        <div class="header-actions">
            <a href="index.html" class="btn">&larr; ZurÃ¼ck</a>
            <h2 id="league-title">Lade Liga...</h2>
            <div></div>
        </div>

        <div class="card">
            <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <label>Spieltag:</label>
                <select id="round-select"
                    style="padding: 8px; font-size: 1rem; border-radius: 6px; border: 1px solid #ddd;"></select>
                <div id="forum-buttons" style="margin-left: auto; display: flex; gap: 8px;">
                    <button id="btn-forum-topic" onclick="openForumTopic()" style="padding: 8px 12px; background: #3B82F6; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 0.9rem;" title="Forum-Diskussion Ã¶ffnen">Forum</button>
                    <button id="btn-create-topic" onclick="createMatchdayTopic()" style="padding: 8px 12px; background: #10B981; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 0.9rem;" title="Spieltag-Topic erstellen">+ Topic</button>
                </div>
            </div>

            <div id="matches-list">
                <!-- Matches populated here -->
                <div style="text-align: center; padding: 20px;">Lade Daten...</div>
            </div>
        </div>

        <div class="save-bar">
            <div id="status-msg" class="status-msg"></div>
            <button class="btn-primary" id="save-btn">Speichern</button>
        </div>
    </div>

    <script>
        const API_BASE = '../api';
        const params = new URLSearchParams(window.location.search);
        const ligaFile = params.get('liga');

        let currentData = null;
        let currentRound = 1;
        let csrfToken = null;

        // Helper: POST with CSRF token
        async function postWithCsrf(url, data) {
            const payload = { ...data, csrf_token: csrfToken };
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await res.json();
            if (result.csrf_token) csrfToken = result.csrf_token;
            return result;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const isAuth = await checkAuth();
            if (!isAuth) {
                window.location.href = 'index.html';
                return;
            }

            if (!ligaFile) {
                alert('Keine Liga ausgewÃ¤hlt');
                window.location.href = 'index.html';
                return;
            }

            loadLeague();

            document.getElementById('save-btn').addEventListener('click', saveChanges);
            document.getElementById('round-select').addEventListener('change', (e) => {
                currentRound = parseInt(e.target.value);
                renderMatches();
            });
        });

        async function checkAuth() {
            try {
                const res = await fetch(`${API_BASE}/check-auth.php`);
                const data = await res.json();
                if (data.csrf_token) csrfToken = data.csrf_token;
                return data.authenticated;
            } catch (e) { return false; }
        }

        async function loadLeague() {
            try {
                const res = await fetch(`${API_BASE}/get-league-data.php?liga=${ligaFile}`);
                const data = await res.json();

                if (data.error) {
                    alert(data.error);
                    return;
                }

                currentData = data;
                document.getElementById('league-title').textContent = data.options.Name;
                document.title = "Edit: " + data.options.Name;

                // Setup Rounds
                const rounds = parseInt(data.options.Rounds);
                const actual = parseInt(data.options.Actual);

                // Check previous selection or default
                currentRound = actual;

                const select = document.getElementById('round-select');
                select.innerHTML = '';
                for (let i = 1; i <= rounds; i++) {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.textContent = `Spieltag ${i}`;
                    if (i === actual) opt.selected = true;
                    select.appendChild(opt);
                }

                renderMatches();

            } catch (e) {
                console.error(e);
                alert("Fehler beim Laden");
            }
        }

        function renderMatches() {
            const container = document.getElementById('matches-list');
            const matches = currentData.matches[currentRound];

            if (!matches || matches.length === 0) {
                container.innerHTML = '<p>Keine Spiele.</p>';
                return;
            }

            let html = '';
            matches.forEach((m, index) => {
                const hGoals = m.home_goals !== null ? m.home_goals : '';
                const gGoals = m.guest_goals !== null ? m.guest_goals : '';

                html += `
                <div class="match-row" data-idx="${index}" data-match-id="${m.id || ''}" style="margin-bottom: 30px; padding-bottom: 30px; border-bottom: 1px solid var(--color-border);">
                    <div class="teams-display">
                        <span style="text-align: right; flex: 1;">${m.home}</span>
                        <span>-</span>
                        <span style="text-align: left; flex: 1;">${m.guest}</span>
                    </div>
                    <div class="inputs-display">
                        <input type="number" class="score-input input-home" value="${hGoals}" placeholder="-">
                        <span>:</span>
                        <input type="number" class="score-input input-guest" value="${gGoals}" placeholder="-">
                    </div>
                    
                    <!-- Match Events Section -->
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.05); background: rgba(0,0,0,0.2); padding: 15px; border-radius: 6px;">
                        <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center;">
                            <h4 style="margin: 0; flex: 1;">Ereignisse</h4>
                            <button class="btn-event" onclick="openEventModal(${index}, '${m.home}', '${m.guest}', ${m.home_id}, ${m.guest_id})" style="padding: 6px 12px; font-size: 0.85rem; background: var(--color-primary); cursor: pointer; border: none; border-radius: 4px; color: white;">âš½ Tor/Karte</button>
                        </div>
                        <div class="events-list" data-match-idx="${index}" style="max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; font-size: 0.9rem;">
                            <!-- Events will be loaded here -->
                            <span style="color: var(--color-text-secondary);">Keine Events</span>
                        </div>
                    </div>
                </div>
            `;
            });

            container.innerHTML = html;
            
            // Load events for each match
            matches.forEach((m, index) => {
                if (m.id) {
                    loadMatchEvents(m.id, index);
                }
            });
        }

        async function loadMatchEvents(matchId, matchIdx) {
            try {
                const res = await fetch(`${API_BASE}/save-match-events.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'get_match_events', match_id: matchId })
                });
                const data = await res.json();
                
                if (data.success && data.events.length > 0) {
                    const listEl = document.querySelector(`.events-list[data-match-idx="${matchIdx}"]`);
                    let html = '';
                    
                    data.events.forEach(e => {
                        const icon = e.event_type === 'goal' ? 'âš½' : e.event_type === 'yellow_card' ? 'ðŸŸ¨' : e.event_type === 'red_card' ? 'ðŸŸ¥' : 'ðŸŽ¯';
                        const name = e.name || e.player_name || 'Unbekannt';
                        const minute = e.minute ? `${e.minute}'` : 'Keine Zeit';
                        
                        html += `
                            <div style="display: flex; justify-content: space-between; padding: 8px; margin: 4px 0; background: rgba(255,255,255,0.05); border-radius: 3px; align-items: center;">
                                <div>
                                    <span style="font-weight: 600;">${icon}</span>
                                    <span style="margin-left: 8px;">${name}</span>
                                    <span style="font-size: 0.8rem; color: var(--color-text-secondary); margin-left: 8px;">${minute}</span>
                                </div>
                                <button onclick="deleteEvent(${e.id})" style="background: rgba(255,0,0,0.3); border: none; color: #ff6b6b; cursor: pointer; padding: 4px 8px; border-radius: 3px; font-size: 0.8rem;">âœ•</button>
                            </div>
                        `;
                    });
                    
                    listEl.innerHTML = html;
                }
            } catch (e) {
                console.error('Error loading match events:', e);
            }
        }

        function openEventModal(matchIdx, homeTeam, awayTeam, homeId, awayId) {
            const match = currentData.matches[currentRound][matchIdx];
            if (!match.id) {
                alert('Speichere erst die Ergebnisse, bevor du Events hinzufÃ¼gst');
                return;
            }

            const teams = [
                { id: homeId, name: homeTeam },
                { id: awayId, name: awayTeam }
            ];

            let html = `
                <div style="padding: 20px;">
                    <h3 style="margin-top: 0;">${homeTeam} vs ${awayTeam}</h3>
                    
                    <div style="margin-bottom: 25px;">
                        <h4>Event-Typ</h4>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="event-type-btn" onclick="selectEventType(this, 'goal')" style="padding: 10px 15px; background: rgba(0,255,136,0.2); border: 2px solid var(--color-live); color: var(--color-live); border-radius: 6px; cursor: pointer; font-weight: 600;">âš½ Tor</button>
                            <button class="event-type-btn" onclick="selectEventType(this, 'yellow_card')" style="padding: 10px 15px; background: rgba(255,255,0,0.1); border: 2px solid transparent; color: white; border-radius: 6px; cursor: pointer;">ðŸŸ¨ Gelbe Karte</button>
                            <button class="event-type-btn" onclick="selectEventType(this, 'red_card')" style="padding: 10px 15px; background: rgba(255,0,0,0.1); border: 2px solid transparent; color: white; border-radius: 6px; cursor: pointer;">ðŸŸ¥ Rote Karte</button>
                            <button class="event-type-btn" onclick="selectEventType(this, 'assist')" style="padding: 10px 15px; background: rgba(100,200,255,0.1); border: 2px solid transparent; color: white; border-radius: 6px; cursor: pointer;">ðŸŽ¯ Assist</button>
                        </div>
                        <input type="hidden" id="modal-event-type" value="goal">
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h4>Team</h4>
                        <select id="modal-event-team" style="width: 100%; padding: 10px; border: 1px solid var(--color-border); background: var(--color-bg-elevated); color: white; border-radius: 6px;">
                            <option value="">Team wÃ¤hlen...</option>
                            ${teams.map(t => `<option value="${t.id}">${t.name}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h4>Spieler (optional)</h4>
                        <input type="text" id="modal-player-name" placeholder="Spielername" style="width: 100%; padding: 10px; border: 1px solid var(--color-border); background: var(--color-bg-elevated); color: white; border-radius: 6px; margin-bottom: 10px;">
                        <label style="font-size: 0.9rem; color: var(--color-text-secondary);">Minute (optional)</label>
                        <input type="number" id="modal-minute" placeholder="z.B. 45" style="width: 100%; padding: 10px; border: 1px solid var(--color-border); background: var(--color-bg-elevated); color: white; border-radius: 6px;" min="0" max="120">
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="saveMatchEvent(${match.id})" style="flex: 1; padding: 12px; background: var(--color-primary); border: none; color: white; border-radius: 6px; cursor: pointer; font-weight: 600;">âœ“ HinzufÃ¼gen</button>
                        <button onclick="closeModal('event-modal')" style="flex: 1; padding: 12px; background: var(--color-bg-elevated); border: 1px solid var(--color-border); color: white; border-radius: 6px; cursor: pointer;">Abbrechen</button>
                    </div>
                </div>
            `;

            showModal('event-modal', html);
        }

        function selectEventType(btn, type) {
            document.querySelectorAll('.event-type-btn').forEach(b => {
                b.style.borderColor = 'transparent';
                b.style.background = b.style.background.replace('0.2', '0.1');
            });
            btn.style.borderColor = window.getComputedStyle(btn).color;
            btn.style.background = window.getComputedStyle(btn).color.replace('rgb', 'rgba').replace(')', ', 0.2)');
            document.getElementById('modal-event-type').value = type;
        }

        function showModal(id, content) {
            let modal = document.getElementById(id);
            if (!modal) {
                modal = document.createElement('div');
                modal.id = id;
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000;';
                document.body.appendChild(modal);
            }
            
            modal.innerHTML = `
                <div style="background: var(--color-bg-card); border: 1px solid var(--color-border); border-radius: 12px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    ${content}
                </div>
            `;
            modal.style.display = 'flex';
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            if (modal) modal.style.display = 'none';
        }

        async function saveMatchEvent(matchId) {
            const eventType = document.getElementById('modal-event-type').value;
            const teamId = parseInt(document.getElementById('modal-event-team').value);
            const playerName = document.getElementById('modal-player-name').value.trim();
            const minute = document.getElementById('modal-minute').value;

            if (!teamId) {
                alert('Bitte Team wÃ¤hlen');
                return;
            }

            try {
                const action = eventType === 'assist' ? 'add_assist' : eventType === 'goal' ? 'add_goal' : 'add_card';
                const payload = {
                    action: action,
                    match_id: matchId,
                    team_id: teamId,
                    player_name: playerName,
                    csrf_token: csrfToken
                };

                if (minute) payload.minute = parseInt(minute);
                if (eventType === 'red_card' || eventType === 'yellow_card') {
                    payload.card_type = eventType;
                }

                const res = await fetch(`${API_BASE}/save-match-events.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await res.json();

                if (result.success) {
                    closeModal('event-modal');
                    // Reload the match data to show new events
                    const matches = currentData.matches[currentRound];
                    const matchIdx = matches.findIndex(m => m.id === matchId);
                    if (matchIdx >= 0) {
                        loadMatchEvents(matchId, matchIdx);
                    }
                } else {
                    alert('Fehler: ' + result.error);
                }
            } catch (e) {
                console.error(e);
                alert('Verbindungsfehler');
            }
        }

        async function deleteEvent(eventId) {
            if (!confirm('Event wirklich lÃ¶schen?')) return;

            try {
                const res = await fetch(`${API_BASE}/save-match-events.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'delete_event', event_id: eventId, csrf_token: csrfToken })
                });
                const result = await res.json();

                if (result.success) {
                    // Reload all matches to refresh
                    renderMatches();
                } else {
                    alert('Fehler beim LÃ¶schen');
                }
            } catch (e) {
                console.error(e);
                alert('Fehler');
            }
        }

        async function saveChanges() {
            const btn = document.getElementById('save-btn');
            const msg = document.getElementById('status-msg');

            btn.disabled = true;
            btn.textContent = 'Speichere...';
            msg.textContent = '';

            // Collect data
            const rows = document.querySelectorAll('.match-row');
            const payloadMatches = [];
            const originalMatches = currentData.matches[currentRound];

            rows.forEach(row => {
                const idx = row.getAttribute('data-idx');
                const hVal = row.querySelector('.input-home').value;
                const gVal = row.querySelector('.input-guest').value;

                const orig = originalMatches[idx];

                payloadMatches.push({
                    home_id: orig.home_id, // Need IDs for the API locator
                    guest_id: orig.guest_id, // Need IDs
                    // Note: The original matches object in currentData (from parser) might need to ensure it has IDs.
                    // Currently LmoParser.php puts IDs in 'home_id' and 'guest_id' in matches array?
                    // Let's check LmoParser.php. Yes, I added 'home_id' and 'guest_id' in the patch earlier.
                    home_goals: hVal,
                    guest_goals: gVal
                });
            });

            try {
                const result = await postWithCsrf(`${API_BASE}/save-matchday.php`, {
                    liga: ligaFile,
                    round: currentRound,
                    matches: payloadMatches
                });

                if (result.success) {
                    msg.textContent = 'Gespeichert! âœ…';
                    msg.style.color = 'green';
                    // Reload data to ensure consistency
                    await loadLeague();
                    // Restore select
                    document.getElementById('round-select').value = currentRound;
                } else {
                    msg.textContent = 'Fehler: ' + (result.error || 'Unbekannt');
                    msg.style.color = 'red';
                }
            } catch (e) {
                console.error(e);
                msg.textContent = 'Verbindungsfehler';
                msg.style.color = 'red';
            }

            btn.disabled = false;
            btn.textContent = 'Speichern';
        }

        // ============================================
        // FORUM INTEGRATION
        // ============================================

        let matchdayTopicId = null;
        let leagueId = null;

        async function loadForumInfo() {
            if (!currentData || !currentData.league_id) return;

            leagueId = currentData.league_id;

            try {
                const res = await fetch(`${API_BASE}/match-forum.php?action=round_topics&league_id=${leagueId}&round_nr=${currentRound}`);
                const data = await res.json();

                if (data.csrf_token) csrfToken = data.csrf_token;

                // PrÃ¼fen ob Spieltag-Topic existiert
                const matchdayTopic = (data.topics || []).find(t => t.topic_type === 'matchday');
                matchdayTopicId = matchdayTopic ? matchdayTopic.id : null;

                updateForumButtons();

            } catch (e) {
                console.error('Error loading forum info:', e);
            }
        }

        function updateForumButtons() {
            const forumBtn = document.getElementById('btn-forum-topic');
            const createBtn = document.getElementById('btn-create-topic');

            if (matchdayTopicId) {
                forumBtn.style.display = 'inline-block';
                createBtn.style.display = 'none';
            } else {
                forumBtn.style.display = 'none';
                createBtn.style.display = 'inline-block';
            }
        }

        function openForumTopic() {
            if (matchdayTopicId) {
                window.open(`../forum.html?topic=${matchdayTopicId}`, '_blank');
            }
        }

        async function createMatchdayTopic() {
            if (!leagueId) {
                alert('Liga-Daten nicht geladen');
                return;
            }

            if (!confirm(`Spieltag-Topic fÃ¼r "${currentData.options?.Name || 'Liga'}" - Spieltag ${currentRound} erstellen?`)) {
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/match-forum.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        action: 'create_matchday_topic',
                        league_id: leagueId,
                        round_nr: currentRound,
                        csrf_token: csrfToken
                    })
                });

                const data = await res.json();

                if (data.success) {
                    if (data.csrf_token) csrfToken = data.csrf_token;
                    matchdayTopicId = data.topic_id;
                    updateForumButtons();

                    if (confirm('Spieltag-Topic erstellt! Jetzt Ã¶ffnen?')) {
                        window.open(`../forum.html?topic=${data.topic_id}`, '_blank');
                    }
                } else {
                    alert(data.error || 'Fehler beim Erstellen');
                }
            } catch (e) {
                alert('Netzwerkfehler');
            }
        }

        // Extend renderMatches to reload forum info
        const originalRenderMatches = renderMatches;
        renderMatches = function() {
            originalRenderMatches();
            loadForumInfo();
        };
    </script>

</body>

</html>